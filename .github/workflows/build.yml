name: Build Tiny iPXE (RTL8152B Only - Final)

on:
  push:
  pull_request:
  workflow_dispatch: # 允许手动触发

jobs:
  build-pure:
    name: Pure Official Source + Tiny Build
    runs-on: ubuntu-latest
    steps:
      - name: 拉取官方纯净iPXE源码（不依赖你的fork，避免污染）
        uses: actions/checkout@v6
        with:
          repository: ipxe/ipxe
          path: ipxe-pure
          ref: master # 拉取最新官方稳定版

      - name: 安装编译依赖（纯净环境）
        run: |
          sudo apt update && sudo apt install -y gcc make binutils liblzma-dev mtools

      - name: 极致精简配置+强制清理（双重保险）
        working-directory: ipxe-pure/src
        run: |
          # 1. 彻底清理所有缓存（包括隐藏文件）
          make clean && rm -rf bin bin-x86_64-efi config/local *.o *.a
          # 2. 创建仅含RTL8152B的配置文件
          mkdir -p config/local
          cat > config/local/config.h <<'EOF'
          #define CONFIG_LOCAL_CONFIG y
          #undef CONFIG_ALL_DRIVERS
          #undef CONFIG_ALL_PROTOCOLS
          #undef CONFIG_ALL_CMD
          #undef CONFIG_ALL_FEATURES
          #undef CONFIG_IPXE
          #define CONFIG_BIOS y
          #define CONFIG_UEFI y
          #define CONFIG_CONSOLE_VGA y
          #define CONFIG_MENU_BASIC y
          #define CONFIG_CMD_CHAIN y
          #define CONFIG_CMD_SHELL y
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y
          #undef CONFIG_HTTP CONFIG_HTTPS CONFIG_TFTP CONFIG_DNS CONFIG_VLAN CONFIG_IPV6
          #undef CONFIG_CMD_PING CONFIG_CMD_DHCP CONFIG_CMD_IFCONFIG CONFIG_CMD_BOOT
          #EOF

      - name: 编译BIOS版（ipxe.pxe）- 双重指定驱动
        working-directory: ipxe-pure/src
        run: |
          # 命令行+配置文件双重锁定驱动，VERBOSE=1打印详细日志
          make bin/ipxe.pxe DRIVERS=usbnet/rtl8152 CONFIG_USB=y VERBOSE=1 NO_WERROR=1
          # 验证大小+代码段
          echo "BIOS文件大小："
          ls -lh bin/ipxe.pxe
          echo "BIOS文件代码段大小："
          size bin/ipxe.pxe

      - name: 编译UEFI版（BOOTX64.EFI）- 双重指定驱动
        working-directory: ipxe-pure/src
        run: |
          make bin-x86_64-efi/ipxe.efi DRIVERS=usbnet/rtl8152 CONFIG_USB=y VERBOSE=1 NO_WERROR=1
          cp bin-x86_64-efi/ipxe.efi bin-x86_64-efi/BOOTX64.EFI
          # 验证大小+代码段
          echo "UEFI文件大小："
          ls -lh bin-x86_64-efi/BOOTX64.EFI
          echo "UEFI文件代码段大小："
          size bin-x86_64-efi/BOOTX64.EFI

      - name: 打包最终产物
        run: |
          mkdir -p ipxe-tiny-final
          cp ipxe-pure/src/bin/ipxe.pxe ipxe-tiny-final/
          cp ipxe-pure/src/bin-x86_64-efi/BOOTX64.EFI ipxe-tiny-final/
          cat > ipxe-tiny-final/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          echo 引导本地硬盘...
          chain hd0||chain hd1
          prompt --timeout 3000 && goto start
          :sh
          echo 输入exit返回菜单
          shell && goto start
          EOF
          tar -zcvf ipxe-tiny-rtl8152-final.tar.gz ipxe-tiny-final/

      - name: 上传产物+日志
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152-final
          path: |
            ipxe-tiny-rtl8152-final.tar.gz
            ipxe-pure/src/*.log # 上传编译日志，方便排查
