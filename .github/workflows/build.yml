name: Build Tiny iPXE (Only RTL8152B)

on:
  push:
  pull_request:

env:
  MAKEFLAGS: "-j4 GITVERSION=${{ github.sha }} NO_WERROR=1"

jobs:
  # BIOS：i386架构 + 强制清理缓存 + 极致精简
  bios:
    name: BIOS / i386 (Tiny RTL8152B)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [i386]
    container:
      image: ghcr.io/ipxe/ipxe-builder-${{ matrix.arch }}
    env:
      bindir: bin
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: 创建极致精简配置文件（覆盖所有冗余）
        working-directory: src
        run: |
          # 强制删除旧配置（如有）
          rm -rf config/local
          mkdir -p config/local
          # 终极精简配置：仅保留引导+USB+RTL8152B
          cat > config/local/config.h <<'EOF'
          #define CONFIG_LOCAL_CONFIG y
          #undef CONFIG_ALL_DRIVERS
          #undef CONFIG_ALL_PROTOCOLS
          #undef CONFIG_ALL_CMD
          #undef CONFIG_ALL_FEATURES

          # 仅开启核心必要功能
          #define CONFIG_BIOS y
          #define CONFIG_UEFI y
          #define CONFIG_CONSOLE_VGA y
          #define CONFIG_MENU_BASIC y
          #define CONFIG_CMD_CHAIN y  # 仅保留硬盘引导需要的chain命令
          #define CONFIG_CMD_SHELL y  # 仅保留shell命令
          #define CONFIG_CMD_PROMPT y # 仅保留prompt命令

          # 仅开启USB+RTL8152B
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y

          # 强制关闭所有冗余功能（逐行屏蔽）
          #undef CONFIG_HTTP
          #undef CONFIG_HTTPS
          #undef CONFIG_TFTP
          #undef CONFIG_ISCSI
          #undef CONFIG_DNS
          #undef CONFIG_NTP
          #undef CONFIG_VLAN
          #undef CONFIG_IPV6
          #undef CONFIG_PING
          #undef CONFIG_CMD_PING
          #undef CONFIG_CMD_DHCP
          #undef CONFIG_CMD_BOOT
          #undef CONFIG_CMD_IFCONFIG
          #undef CONFIG_CMD_LOGIN
          #undef CONFIG_CMD_IMGPATH
          #undef CONFIG_IMAGE_TRUST_CMD
          #undef CONFIG_FTP
          #undef CONFIG_SMB
          #undef CONFIG_NFS
          #undef CONFIG_SLIP
          #undef CONFIG_PPP
          #undef CONFIG_WIFI
          #EOF

      - name: 强制清理旧编译缓存（关键！）
        working-directory: src
        run: |
          make clean  # 彻底删除bin目录和所有.o/.a文件
          rm -rf ${{ env.bindir }}  # 手动删除旧的bin目录

      - name: 重新编译BIOS版ipxe.pxe（无缓存）
        working-directory: src
        run: |
          make ${{ env.bindir }}/ipxe.pxe

      - name: 验证BIOS文件大小（调试）
        run: |
          ls -lh src/${{ env.bindir }}/ipxe.pxe  # 输出文件大小，确认精简生效

      - name: 上传BIOS产物
        uses: actions/upload-artifact@v6
        with:
          name: bios-i386-tiny
          if-no-files-found: error
          path: src/${{ env.bindir }}/ipxe.pxe

  # UEFI：x86_64 + 同样清理缓存+精简
  uefi:
    name: UEFI / x86_64 (Tiny RTL8152B)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
    container:
      image: ghcr.io/ipxe/ipxe-builder-${{ matrix.arch }}
    env:
      bindir: bin-${{ matrix.arch }}-efi
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: 创建极致精简配置文件
        working-directory: src
        run: |
          rm -rf config/local
          mkdir -p config/local
          cat > config/local/config.h <<'EOF'
          #define CONFIG_LOCAL_CONFIG y
          #undef CONFIG_ALL_DRIVERS
          #undef CONFIG_ALL_PROTOCOLS
          #undef CONFIG_ALL_CMD
          #undef CONFIG_ALL_FEATURES

          # 仅开启核心必要功能
          #define CONFIG_BIOS y
          #define CONFIG_UEFI y
          #define CONFIG_CONSOLE_VGA y
          #define CONFIG_MENU_BASIC y
          #define CONFIG_CMD_CHAIN y
          #define CONFIG_CMD_SHELL y
          #define CONFIG_CMD_PROMPT y

          # 仅开启USB+RTL8152B
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y

          # 强制关闭所有冗余
          #undef CONFIG_HTTP
          #undef CONFIG_HTTPS
          #undef CONFIG_TFTP
          #undef CONFIG_ISCSI
          #undef CONFIG_DNS
          #undef CONFIG_NTP
          #undef CONFIG_VLAN
          #undef CONFIG_IPV6
          #undef CONFIG_PING
          #undef CONFIG_CMD_PING
          #undef CONFIG_CMD_DHCP
          #undef CONFIG_CMD_BOOT
          #undef CONFIG_CMD_IFCONFIG
          #undef CONFIG_CMD_LOGIN
          #undef CONFIG_IMAGE_TRUST_CMD
          #undef CONFIG_FTP
          #undef CONFIG_SMB
          #undef CONFIG_NFS
          #undef CONFIG_SLIP
          #undef CONFIG_PPP
          #undef CONFIG_WIFI
          #EOF

      - name: 强制清理旧编译缓存
        working-directory: src
        run: |
          make clean
          rm -rf ${{ env.bindir }}

      - name: 重新编译UEFI版ipxe.efi
        working-directory: src
        run: |
          make ${{ env.bindir }}/ipxe.efi
          cp ${{ env.bindir }}/ipxe.efi ${{ env.bindir }}/BOOTX64.EFI

      - name: 验证UEFI文件大小（调试）
        run: |
          ls -lh src/${{ env.bindir }}/BOOTX64.EFI  # 输出文件大小

      - name: 上传UEFI产物
        uses: actions/upload-artifact@v6
        with:
          name: uefi-x86_64-tiny
          if-no-files-found: error
          path: src/${{ env.bindir }}/BOOTX64.EFI

  # 打包产物
  combine:
    name: Combine Tiny iPXE
    runs-on: ubuntu-latest
    needs: [bios, uefi]
    container:
      image: ghcr.io/ipxe/ipxe-signer
    steps:
      - name: 下载精简后的产物
        uses: actions/download-artifact@v7
        with:
          pattern: "{bios-i386-tiny,uefi-x86_64-tiny}"
          path: ./

      - name: 验证下载的文件大小
        run: |
          ls -lh ./  # 确认文件大小已精简

      - name: 打包超小体积文件
        run: |
          mkdir -p ipxe-tiny-rtl8152
          cp ./bios-i386-tiny/ipxe.pxe ipxe-tiny-rtl8152/
          cp ./uefi-x86_64-tiny/BOOTX64.EFI ipxe-tiny-rtl8152/
          # 超精简菜单脚本
          cat > ipxe-tiny-rtl8152/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          echo 引导本地硬盘...
          chain hd0||chain hd1
          prompt --timeout 3000 && goto start
          :sh
          echo 输入exit返回菜单
          shell && goto start
          EOF
          tar -zcvf ipxe-tiny-rtl8152.tar.gz ipxe-tiny-rtl8152/

      - name: 上传最终产物
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152-final
          if-no-files-found: error
          path: ipxe-tiny-rtl8152.tar.gz
