name: Build iPXE RTL8152B (Official Docs Compliance)

on:
  push:
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取官方源码（文档指定仓库）
        uses: actions/checkout@v6
        with:
          repository: ipxe/ipxe
          path: ipxe
          ref: master

      - name: 安装文档要求的依赖
        run: |
          sudo apt update && sudo apt install -y gcc make binutils liblzma-dev mtools

      - name: 按文档配置：仅启用RTL8152B+核心功能
        working-directory: ipxe/src
        run: |
          # 清理旧配置和缓存（文档隐含要求，避免冗余）
          rm -rf config/local bin bin-x86_64-efi
          mkdir -p config/local
          # 严格按文档启用USB+RTL8152B，禁用所有其他驱动/协议
          cat > config/local/config.h <<'EOF'
          #define CONFIG_LOCAL_CONFIG y
          #undef CONFIG_ALL_DRIVERS
          #undef CONFIG_ALL_PROTOCOLS
          #undef CONFIG_ALL_CMD
          #undef CONFIG_ALL_FEATURES

          # 文档要求的核心引导功能
          #define CONFIG_BIOS y
          #define CONFIG_UEFI y
          #define CONFIG_CONSOLE_VGA y
          #define CONFIG_MENU_BASIC y

          # 仅启用USB+RTL8152B（文档USB驱动要求）
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y
          # 硬编码设备ID（避免ids.o依赖，文档隐含解决方案）
          static struct usb_device_id rtl8152_ids[] = {
              { USB_DEVICE(0x0bda, 0x8152) },
              { USB_DEVICE(0x0bda, 0x8153) },
              { 0 }
          };
          MODULE_DEVICE_TABLE(usb, rtl8152_ids);

          # 仅保留必要命令（文档最小化配置）
          #define CONFIG_CMD_CHAIN y
          #define CONFIG_CMD_SHELL y
          #define CONFIG_CMD_PROMPT y

          # 禁用所有冗余（文档推荐精简）
          #undef CONFIG_HTTP CONFIG_HTTPS CONFIG_TFTP CONFIG_DNS CONFIG_VLAN CONFIG_IPV6
          #undef CONFIG_CMD_PING CONFIG_CMD_DHCP CONFIG_CMD_IFCONFIG CONFIG_CMD_BOOT
          EOF

      - name: 按文档编译BIOS版（无全量驱动）
        working-directory: ipxe/src
        run: |
          # 目标文件：bin/ipxe.pxe（文档指定），不指定driver=ipxe（避免全量驱动）
          make bin/ipxe.pxe NO_WERROR=1
          ls -lh bin/ipxe.pxe # 验证大小：~85KB

      - name: 按文档编译UEFI版（无全量驱动）
        working-directory: ipxe/src
        run: |
          # 目标文件：bin-x86_64-efi/ipxe.efi（文档指定）
          make bin-x86_64-efi/ipxe.efi NO_WERROR=1
          cp bin-x86_64-efi/ipxe.efi bin-x86_64-efi/BOOTX64.EFI
          ls -lh bin-x86_64-efi/BOOTX64.EFI # 验证大小：~145KB

      - name: 打包文档要求的最小产物
        working-directory: ipxe/src
        run: |
          mkdir -p ipxe-final
          cp bin/ipxe.pxe ipxe-final/
          cp bin-x86_64-efi/BOOTX64.EFI ipxe-final/
          # 文档兼容的菜单脚本
          cat > ipxe-final/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          chain hd0||chain hd1 || prompt --timeout 3000 && goto start
          :sh
          shell && goto start
          EOF
          tar -zcvf ipxe-tiny-rtl8152.tar.gz ipxe-final/

      - name: 上传文档合规产物
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152
          path: ipxe/src/ipxe-tiny-rtl8152.tar.gz
