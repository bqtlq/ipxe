name: Build Tiny iPXE (RTL8152B - Fix IDS Error)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-fix-ids:
    name: Fix RTL8152 IDS + Tiny Build
    runs-on: ubuntu-latest
    steps:
      - name: 拉取官方纯净源码
        uses: actions/checkout@v6
        with:
          repository: ipxe/ipxe
          path: ipxe-pure
          ref: master

      - name: 安装编译依赖（含ids2c工具依赖）
        run: |
          sudo apt update && sudo apt install -y gcc make binutils liblzma-dev mtools python3

      - name: 手动生成RTL8152 IDS文件（核心修复！）
        working-directory: ipxe-pure/src
        run: |
          # 1. 彻底清理缓存
          make clean && rm -rf bin bin-x86_64-efi config/local *.o *.a
          # 2. 创建配置文件（仅开启核心功能）
          mkdir -p config/local
          cat > config/local/config.h <<'EOF'
          #define CONFIG_LOCAL_CONFIG y
          #undef CONFIG_ALL_DRIVERS
          #undef CONFIG_ALL_PROTOCOLS
          #undef CONFIG_ALL_CMD
          #undef CONFIG_ALL_FEATURES
          #define CONFIG_BIOS y
          #define CONFIG_UEFI y
          #define CONFIG_CONSOLE_VGA y
          #define CONFIG_MENU_BASIC y
          #define CONFIG_CMD_CHAIN y
          #define CONFIG_CMD_SHELL y
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #EOF
          # 3. 手动触发ids2c工具，生成RTL8152的IDS C代码
          # ids2c是iPXE自带的工具，将.ids文件转成C代码
          ./util/ids2c drivers/usbnet/rtl8152.ids > drivers/usbnet/rtl8152_ids.c
          # 4. 手动创建RTL8152的Makefile片段，指定IDS文件依赖
          echo 'drivers/usbnet/rtl8152.o: drivers/usbnet/rtl8152_ids.c' >> Makefile
          echo 'bin/rtl8152.ids.o: drivers/usbnet/rtl8152_ids.c' >> Makefile
          echo 'bin-x86_64-efi/rtl8152.ids.o: drivers/usbnet/rtl8152_ids.c' >> Makefile

      - name: 编译BIOS版（ipxe.pxe）- 仅RTL8152B
        working-directory: ipxe-pure/src
        run: |
          # 显式指定仅编译RTL8152驱动，跳过其他USB驱动
          make bin/ipxe.pxe DRIVERS=usbnet/rtl8152 CONFIG_USB_NET_RTL8152=y VERBOSE=1 NO_WERROR=1
          # 验证大小
          echo "BIOS文件大小："
          ls -lh bin/ipxe.pxe

      - name: 编译UEFI版（BOOTX64.EFI）- 仅RTL8152B
        working-directory: ipxe-pure/src
        run: |
          make bin-x86_64-efi/ipxe.efi DRIVERS=usbnet/rtl8152 CONFIG_USB_NET_RTL8152=y VERBOSE=1 NO_WERROR=1
          cp bin-x86_64-efi/ipxe.efi bin-x86_64-efi/BOOTX64.EFI
          # 验证大小
          echo "UEFI文件大小："
          ls -lh bin-x86_64-efi/BOOTX64.EFI

      - name: 打包最终产物
        run: |
          mkdir -p ipxe-tiny-final
          cp ipxe-pure/src/bin/ipxe.pxe ipxe-tiny-final/
          cp ipxe-pure/src/bin-x86_64-efi/BOOTX64.EFI ipxe-tiny-final/
          cat > ipxe-tiny-final/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          echo 引导本地硬盘...
          chain hd0||chain hd1
          prompt --timeout 3000 && goto start
          :sh
          echo 输入exit返回菜单
          shell && goto start
          EOF
          tar -zcvf ipxe-tiny-rtl8152-final.tar.gz ipxe-tiny-final/

      - name: 上传产物
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152-final
          path: ipxe-tiny-rtl8152-final.tar.gz
