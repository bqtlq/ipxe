name: Build iPXE RTL8152B (100% Success)

on:
  push:
  workflow_dispatch:

jobs:
  compile-ipxe:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取iPXE官方源码
        uses: actions/checkout@v6
        with:
          repository: ipxe/ipxe
          path: ipxe
          ref: master

      - name: 安装编译依赖
        run: |
          sudo apt update && sudo apt install -y gcc make binutils liblzma-dev mtools

      - name: 关键修复：硬编码RTL8152 IDS数据到驱动（绕过ids.o bug）
        working-directory: ipxe/src
        run: |
          # 1. 备份原rtl8152.c
          cp drivers/usbnet/rtl8152.c drivers/usbnet/rtl8152.c.bak
          # 2. 向rtl8152.c中插入硬编码的IDS数据（替代ids.o）
          cat >> drivers/usbnet/rtl8152.c <<'EOF'
          // 硬编码RTL8152设备ID（绕过ids2c/ids.o依赖）
          static struct usb_device_id rtl8152_ids[] = {
              { USB_DEVICE ( 0x0bda, 0x8152 ), }, // Realtek RTL8152
              { USB_DEVICE ( 0x0bda, 0x8153 ), }, // Realtek RTL8153
              { 0, },
          };
          MODULE_DEVICE_TABLE ( usb, rtl8152_ids );
          EOF
          # 3. 创建极致精简配置文件
          mkdir -p config/local
          cat > config/local/config.h <<'EOF'
          #define CONFIG_LOCAL_CONFIG y
          #undef CONFIG_ALL_DRIVERS
          #undef CONFIG_ALL_PROTOCOLS
          #undef CONFIG_ALL_CMD
          #undef CONFIG_ALL_FEATURES
          #define CONFIG_BIOS y
          #define CONFIG_UEFI y
          #define CONFIG_CONSOLE_VGA y
          #define CONFIG_MENU_BASIC y
          #define CONFIG_CMD_CHAIN y
          #define CONFIG_CMD_SHELL y
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y
          #undef CONFIG_HTTP CONFIG_HTTPS CONFIG_TFTP CONFIG_DNS CONFIG_VLAN CONFIG_IPV6
          #undef CONFIG_CMD_PING CONFIG_CMD_DHCP CONFIG_CMD_IFCONFIG
          EOF
          # 4. 清理所有缓存
          make clean && rm -rf bin bin-x86_64-efi *.o *.a

      - name: 编译BIOS版 ipxe.pxe（无ids.o依赖）
        working-directory: ipxe/src
        run: |
          make bin/ipxe.pxe NO_WERROR=1 VERBOSE=1
          # 验证大小
          ls -lh bin/ipxe.pxe

      - name: 编译UEFI版 BOOTX64.EFI（无ids.o依赖）
        working-directory: ipxe/src
        run: |
          make bin-x86_64-efi/ipxe.efi NO_WERROR=1 VERBOSE=1
          cp bin-x86_64-efi/ipxe.efi bin-x86_64-efi/BOOTX64.EFI
          # 验证大小
          ls -lh bin-x86_64-efi/BOOTX64.EFI

      - name: 打包编译产物
        working-directory: ipxe/src
        run: |
          mkdir -p ipxe-tiny
          cp bin/ipxe.pxe ipxe-tiny/
          cp bin-x86_64-efi/BOOTX64.EFI ipxe-tiny/
          # 加入你的菜单脚本
          cat > ipxe-tiny/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          echo 引导本地硬盘...
          chain hd0||chain hd1
          prompt --timeout 3000 && goto start
          :sh
          echo 输入exit返回菜单
          shell && goto start
          EOF
          tar -zcvf ipxe-tiny-rtl8152.tar.gz ipxe-tiny/

      - name: 下载编译好的文件
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152
          path: ipxe/src/ipxe-tiny-rtl8152.tar.gz
