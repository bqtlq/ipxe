name: Build Tiny iPXE (Only RTL8152B)

on:
  push:
  pull_request:

env:
  MAKEFLAGS: "-j4 GITVERSION=${{ github.sha }}"

jobs:
  # BIOS：i386架构（原生兼容所有x86主板）
  bios:
    name: BIOS / i386 (Only RTL8152B)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [i386]
    container:
      image: ghcr.io/ipxe/ipxe-builder-${{ matrix.arch }}
    env:
      bindir: bin
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: 创建iPXE本地配置文件（关键！）
        working-directory: src
        run: |
          # 创建local配置目录（若不存在）
          mkdir -p config/local
          # 写入配置：仅开启USB + RTL8152驱动，关闭所有其他驱动
          cat > config/local/config.h <<'EOF'
          #undef CONFIG_ALL_DRIVERS
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y
          #undef CONFIG_USB_NET_REALTEK
          #undef CONFIG_USB_NET_ASIX
          #undef CONFIG_USB_NET_MCS7830
          #undef CONFIG_USB_NET_SMSC95XX
          #EOF

      - name: 编译BIOS版ipxe.pxe（仅RTL8152B）
        working-directory: src
        run: |
          # 无需命令行传参，配置文件已指定所有驱动
          make ${{ env.bindir }}/ipxe.pxe

      - name: 上传BIOS产物
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.bindir }}
          if-no-files-found: error
          path: src/${{ env.bindir }}/ipxe.pxe

  # UEFI：x86_64架构（同样用本地配置文件）
  uefi:
    name: UEFI / x86_64 (Only RTL8152B)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
    container:
      image: ghcr.io/ipxe/ipxe-builder-${{ matrix.arch }}
    env:
      bindir: bin-${{ matrix.arch }}-efi
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: 创建iPXE本地配置文件（关键！）
        working-directory: src
        run: |
          mkdir -p config/local
          cat > config/local/config.h <<'EOF'
          #undef CONFIG_ALL_DRIVERS
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y
          #undef CONFIG_USB_NET_REALTEK
          #undef CONFIG_USB_NET_ASIX
          #undef CONFIG_USB_NET_MCS7830
          #undef CONFIG_USB_NET_SMSC95XX
          #EOF

      - name: 编译UEFI版ipxe.efi（仅RTL8152B）
        working-directory: src
        run: |
          make ${{ env.bindir }}/ipxe.efi
          cp ${{ env.bindir }}/ipxe.efi ${{ env.bindir }}/BOOTX64.EFI

      - name: 上传UEFI产物
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.bindir }}
          if-no-files-found: error
          path: |
            src/${{ env.bindir }}/BOOTX64.EFI

  # 打包最终产物（BIOS+UEFI）
  combine:
    name: Combine (BIOS + UEFI)
    runs-on: ubuntu-latest
    needs: [bios, uefi]
    container:
      image: ghcr.io/ipxe/ipxe-signer
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: 下载编译产物
        uses: actions/download-artifact@v7
        with:
          pattern: "{bin,bin-x86_64-efi}"
          path: src/

      - name: 打包超小体积iPXE文件
        run: |
          mkdir -p ipxe-tiny-rtl8152
          # 复制核心文件
          cp src/bin/ipxe.pxe ipxe-tiny-rtl8152/
          cp src/bin-x86_64-efi/BOOTX64.EFI ipxe-tiny-rtl8152/
          # 加入超精简菜单脚本
          cat > ipxe-tiny-rtl8152/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          echo 引导本地硬盘...
          chain hd0||chain hd1
          prompt --timeout 3000 && goto start
          :sh
          echo 输入exit返回菜单
          shell && goto start
          EOF
          # 打包成zip
          zip -r ipxe-tiny-rtl8152.zip ipxe-tiny-rtl8152/

      - name: 上传最终产物
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152
          if-no-files-found: error
          path: ipxe-tiny-rtl8152.zip
