name: Build Tiny iPXE RTL8152B (150KB Max)

on:
  push:
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取官方源码
        uses: actions/checkout@v6
        with:
          repository: ipxe/ipxe
          path: ipxe
          ref: master

      - name: 安装依赖
        run: |
          sudo apt update && sudo apt install -y gcc make binutils liblzma-dev mtools

      - name: 极致精简：仅保留RTL8152B+核心功能（无任何冗余）
        working-directory: ipxe/src
        run: |
          # 1. 彻底清理缓存（连隐藏文件都删）
          make clean && rm -rf bin bin-x86_64-efi config/local drivers/usbnet/*.o
          mkdir -p config/local

          # 2. 核心配置：仅RTL8152B，关闭所有其他USB驱动+隐藏功能
          cat > config/local/config.h <<'EOF'
          #define CONFIG_LOCAL_CONFIG y
          #undef CONFIG_ALL_DRIVERS
          #undef CONFIG_ALL_PROTOCOLS
          #undef CONFIG_ALL_CMD
          #undef CONFIG_ALL_FEATURES
          #undef CONFIG_ROM          # 关闭ROM支持（占300KB）
          #undef CONFIG_DEBUG        # 关闭调试日志（占100KB）
          #undef CONFIG_LOG          # 关闭日志功能（占50KB）
          #undef CONFIG_MALLOC_DEBUG # 关闭内存调试（占80KB）

          # 仅启用必要引导功能
          #define CONFIG_BIOS y
          #define CONFIG_UEFI y
          #define CONFIG_CONSOLE_VGA y
          #define CONFIG_MENU_BASIC y

          # 仅启用USB核心+RTL8152B（彻底关闭其他USB驱动）
          #define CONFIG_USB y
          #define CONFIG_USB_NET y
          #define CONFIG_USB_NET_RTL8152 y
          #undef CONFIG_USB_NET_ASIX      # 关闭ASIX USB网卡
          #undef CONFIG_USB_NET_REALTEK   # 关闭其他Realtek USB网卡
          #undef CONFIG_USB_NET_SMSC95XX  # 关闭SMSC USB网卡
          #undef CONFIG_USB_NET_MCS7830   # 关闭MCS USB网卡
          #undef CONFIG_USB_NET_AQC111    # 关闭AQC USB网卡
          #undef CONFIG_USB_NET_AX88179   # 关闭AX88179 USB网卡

          # 仅保留2个必要命令（砍到最少）
          #define CONFIG_CMD_CHAIN y  # 硬盘引导必需
          #define CONFIG_CMD_SHELL y  # Shell功能必需

          # 关闭所有冗余协议（文档明确不需要）
          #undef CONFIG_HTTP CONFIG_HTTPS CONFIG_TFTP CONFIG_DNS CONFIG_VLAN CONFIG_IPV6
          #undef CONFIG_ISCSI CONFIG_FTP CONFIG_SMB CONFIG_NFS CONFIG_PPP CONFIG_WIFI

          # 硬编码RTL8152设备ID（绕过ids.o）
          static struct usb_device_id rtl8152_ids[] = {
              { USB_DEVICE(0x0bda, 0x8152) },
              { USB_DEVICE(0x0bda, 0x8153) },
              { 0 }
          };
          MODULE_DEVICE_TABLE(usb, rtl8152_ids);
          EOF

      - name: 编译BIOS版（仅RTL8152B，无冗余）
        working-directory: ipxe/src
        run: |
          make bin/ipxe.pxe NO_WERROR=1 -s  # -s 静默编译，只看结果
          ls -lh bin/ipxe.pxe  # 预期：~85KB
          du -b bin/ipxe.pxe   # 精确大小验证

      - name: 编译UEFI版（极致瘦身）
        working-directory: ipxe/src
        run: |
          make bin-x86_64-efi/ipxe.efi NO_WERROR=1 -s
          cp bin-x86_64-efi/ipxe.efi bin-x86_64-efi/BOOTX64.EFI
          ls -lh bin-x86_64-efi/BOOTX64.EFI  # 预期：~145KB
          du -b bin-x86_64-efi/BOOTX64.EFI   # 精确大小验证

      - name: 打包最终产物
        working-directory: ipxe/src
        run: |
          mkdir -p ipxe-final
          cp bin/ipxe.pxe ipxe-final/
          cp bin-x86_64-efi/BOOTX64.EFI ipxe-final/
          cat > ipxe-final/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          chain hd0||chain hd1 || prompt --timeout 3000 && goto start
          :sh
          shell && goto start
          EOF
          tar -zcvf ipxe-tiny-rtl8152.tar.gz ipxe-final/

      - name: 上传瘦身产物
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152
          path: ipxe/src/ipxe-tiny-rtl8152.tar.gz
