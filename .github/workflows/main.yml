name: Build Tiny iPXE (Only RTL8152B)

on:
  push:
  pull_request:

env:
  # 保留并行编译，添加DRIVERS全局变量（仅RTL8152B）
  MAKEFLAGS: "-j4 GITVERSION=${{ github.sha }} DRIVERS=usbnet/rtl8152"

jobs:
  # ========== 第一步：仅编译x86_64 BIOS版（砍掉i386 BIOS，仅留x86_64） ==========
  bios:
    name: BIOS / x86_64 (Only RTL8152B)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64] # 仅保留x86_64，砍掉i386
    container:
      image: ghcr.io/ipxe/ipxe-builder-${{ matrix.arch }}
    env:
      bindir: bin-x86_64-pcbios
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Build (Only RTL8152B)
        working-directory: src
        run: |
          # 仅编译需要的BIOS文件：ipxe.pxe（核心），砍掉其他冗余文件（iso/usb/rom等）
          make ${{ env.bindir }}/ipxe.pxe

      - name: Upload BIOS artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.bindir }}
          if-no-files-found: error
          path: src/${{ env.bindir }}/ipxe.pxe

  # ========== 第二步：仅编译x86_64 UEFI版（砍掉所有非x86_64架构） ==========
  uefi:
    name: UEFI / x86_64 (Only RTL8152B)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64] # 仅保留x86_64，砍掉arm/riscv/loong64等
    container:
      image: ghcr.io/ipxe/ipxe-builder-${{ matrix.arch }}
    env:
      bindir: bin-${{ matrix.arch }}-efi
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Build (Only RTL8152B)
        working-directory: src
        run: |
          # 仅编译需要的UEFI文件：ipxe.efi，砍掉snponly.efi/iso/usb等
          make ${{ env.bindir }}/ipxe.efi
          # 重命名为BOOTX64.EFI（符合UEFI规范）
          cp ${{ env.bindir }}/ipxe.efi ${{ env.bindir }}/BOOTX64.EFI

      - name: Upload UEFI artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.bindir }}
          if-no-files-found: error
          path: |
            src/${{ env.bindir }}/BOOTX64.EFI

  # ========== 第三步：精简Combine步骤，仅打包需要的2个文件 ==========
  combine:
    name: Combine (BIOS + UEFI x86_64)
    runs-on: ubuntu-latest
    needs: [bios, uefi] # 仅依赖x86_64 BIOS/UEFI
    container:
      image: ghcr.io/ipxe/ipxe-signer
    env:
      # 仅保留x86_64 BIOS/UEFI文件，砍掉所有其他架构
      binaries: >-
        bin-x86_64-pcbios/ipxe.pxe
        bin-x86_64-efi/BOOTX64.EFI
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Download artifacts (BIOS + UEFI)
        uses: actions/download-artifact@v7
        with:
          pattern: "{bin-x86_64-pcbios,bin-x86_64-efi}"
          path: src/ # 放到src目录，和编译路径一致

      - name: Pack tiny iPXE files (Only RTL8152B)
        run: |
          # 创建输出目录
          mkdir -p ipxe-tiny-rtl8152
          # 复制核心文件
          cp src/bin-x86_64-pcbios/ipxe.pxe ipxe-tiny-rtl8152/
          cp src/bin-x86_64-efi/BOOTX64.EFI ipxe-tiny-rtl8152/
          # 加入超精简的autoexec.ipxe（菜单功能）
          cat > ipxe-tiny-rtl8152/autoexec.ipxe <<'EOF'
          #!ipxe
          quiet:cls
          :start
          menu 引导菜单
          item 1 hd 硬盘引导(10s自动)
          item 2 sh 进入iPXE Shell
          choose --timeout 10000 s || goto hd
          goto ${s}
          :hd
          echo 引导本地硬盘...
          chain hd0||chain hd1
          prompt --timeout 3000 && goto start
          :sh
          echo 输入exit返回菜单
          shell && goto start
          EOF
          # 打包成zip，方便下载
          zip -r ipxe-tiny-rtl8152.zip ipxe-tiny-rtl8152/

      - name: Upload final tiny package
        uses: actions/upload-artifact@v6
        with:
          name: ipxe-tiny-rtl8152
          if-no-files-found: error
          path: ipxe-tiny-rtl8152.zip

  # ========== 砍掉所有无用的Job：sbi、tests、publish ==========
  # （原版的sbi/riscv/loong64/arm等架构完全无用，tests是测试步骤，publish是发布到pages，全部砍掉）
